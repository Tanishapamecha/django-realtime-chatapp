<!DOCTYPE html>
<html>
<head>
    <title>Chat Room</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        #chat-log {
            height: 350px;
            overflow-y: auto;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 5px;
            display: flex;
            flex-direction: column;
        }
        .message {
            max-width: 75%;
            padding: 10px 15px;
            margin: 5px 0;
            border-radius: 15px;
            position: relative;
            word-wrap: break-word;
        }
        .message .timestamp {
            font-size: 0.75rem;
            color: #666;
            margin-top: 5px;
            text-align: right;
        }
        .message.left {
            background-color: #e9ecef;
            align-self: flex-start;
        }
        .message.right {
            background-color: #d1e7dd;
            align-self: flex-end;
            text-align: right;
        }
        #online-users, #offline-users {
            list-style: none;
            padding-left: 0;
        }
        #online-users li, #offline-users li {
            margin-bottom: 5px;
        }
    </style>
</head>
<body class="bg-light">
<div class="container mt-5">
    <div class="row">
        <!-- Chat Box -->
        <div class="col-md-8">
            <div class="card shadow rounded">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">Chat Room: {{ room_name }}</h4>
                    <small>Username: {{ username }}</small>
                </div>
                <div class="card-body" id="chat-log">
                    <!-- Messages will be shown here -->
                </div>
                <div class="card-footer">
                    <div class="input-group">
                        <input id="chat-message-input" type="text" class="form-control" placeholder="Type your message..." autocomplete="off" />
                        <button id="chat-message-submit" class="btn btn-success">Send</button>
                    </div>
                    <a href="{% url 'home' %}" class="btn btn-link mt-2">← Back to Home</a>
                </div>
            </div>
        </div>

        <!-- Online/Offline Users -->
        <div class="col-md-4">
            <div class="card shadow rounded mb-3">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">Online Users</h5>
                </div>
                <div class="card-body">
                    <ul id="online-users"></ul>
                </div>
            </div>

            <div class="card shadow rounded">
                <div class="card-header bg-danger text-white">
                    <h5 class="mb-0">Offline Users</h5>
                </div>
                <div class="card-body">
                    <ul id="offline-users"></ul>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript Logic -->
<script>
    const roomName = "{{ room_name }}";
    const username = "{{ username }}";

    // WebSocket connection
    const chatSocket = new WebSocket(
        'ws://' + window.location.host + '/ws/chat/' + roomName + '/?username=' + encodeURIComponent(username)
    );

    // When WebSocket is connected
    chatSocket.onopen = function () {
        console.log("✅ Connected to chat server");
    };

    // When WebSocket receives message
    chatSocket.onmessage = function (e) {
        const data = JSON.parse(e.data);
        const chatLog = document.getElementById('chat-log');

        if (data.type === 'chat_message') {
            const msgDiv = document.createElement('div');
            msgDiv.classList.add('message');

            const isMine = data.username === username;
            msgDiv.classList.add(isMine ? 'right' : 'left');

            msgDiv.innerHTML = `
                <strong>${data.username}</strong><br>
                ${data.message}
                <div class="timestamp">${data.timestamp}</div>
            `;
            chatLog.appendChild(msgDiv);
            chatLog.scrollTop = chatLog.scrollHeight;

        } else if (data.type === 'online_users_update') {
            updateUserLists(data.users, data.offline_users);
        }
    };

    // Update user lists (online and offline)
    function updateUserLists(onlineList, offlineDict) {
        const onlineDiv = document.getElementById('online-users');
        const offlineDiv = document.getElementById('offline-users');

        onlineDiv.innerHTML = '';
        offlineDiv.innerHTML = '';

        onlineList.forEach(user => {
            const li = document.createElement('li');
            li.textContent = user;
            onlineDiv.appendChild(li);
        });

        for (const [user, lastSeen] of Object.entries(offlineDict)) {
            const li = document.createElement('li');
            li.textContent = `${user} (last seen: ${lastSeen})`;
            offlineDiv.appendChild(li);
        }
    }

    // Send message
    document.getElementById('chat-message-submit').onclick = function () {
        const input = document.getElementById('chat-message-input');
        const msg = input.value.trim();
        if (msg) {
            chatSocket.send(JSON.stringify({
                'type': 'chat_message',
                'message': msg
            }));
            input.value = '';
        }
    };

    // Press Enter to send
    document.getElementById('chat-message-input').addEventListener('keyup', function (e) {
        if (e.key === 'Enter') {
            document.getElementById('chat-message-submit').click();
        }
    });
</script>
</body>
</html>